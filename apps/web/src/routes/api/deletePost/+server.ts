import { PrismaClient } from '@prisma/client';
import { json } from '@sveltejs/kit';
import type { JSONSchemaType } from 'ajv';
import Ajv from 'ajv';
import jwt from 'jsonwebtoken';

const ajv = new Ajv();
const prisma = new PrismaClient();

interface Data {
  token: string;
  post_id: number;
}

const schema: JSONSchemaType<Data> = {
  type: 'object',
  properties: {
    post_id: { type: 'number' },
    token: { type: 'string' }
  },
  required: ['token', 'post_id']
};

const validate = ajv.compile(schema);

export async function DELETE(params: any) {
  const data = params.request.json();
  if (!validate(data)) {
    return await json(validate.errors);
  }
  let user_id;
  try {
    // @ts-ignore
    user_id = jwt.decode(data.token).id;
  } catch {
    return await json('Invalid token');
  }
  const post = await prisma.post.findUnique({
    where: {
      post_id: data.post_id
    }
  });

  if (post?.user_id === user_id) {
    await prisma.post.delete({
      where: {
        post_id: data.post_id
      }
    });
    return await json('Deleted post');
  }
  return await json('There was an error in deleting the post');
}
