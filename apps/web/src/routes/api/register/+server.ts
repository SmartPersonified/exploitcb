import { json } from '@sveltejs/kit';
import type { JSONSchemaType } from 'ajv';
import Ajv from 'ajv';
import { PrismaClient } from '@prisma/client';
import * as argon2 from "argon2"

const ajv = new Ajv();
const prisma = new PrismaClient()

interface Data {
  username: string;
  password: string;
  email: string;
}

const schema: JSONSchemaType<Data> = {
  type: 'object',
  properties: {
    email: { type: 'string' },
    password: { type: 'string' },
    username: { type: 'string' }
  },
  required: ['username', 'password', 'email'],
  additionalProperties: false
};

const validate = ajv.compile(schema)

export async function POST(params: any) {
  const data = await params.request.json();
  if (!validate(data)) {
    return await json(validate.errors)
  }
  await prisma.user.create({
    data: {
      email: data.email,
      username: data.username,
      password: data.password
    }
  })
  return await json("OK")
}
